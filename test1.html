<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>脱毛シミュレーター（テスト）</title>

<style>
body{
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
    margin:0;
    background:#f4f6f8;
    color:#222;
}

.container{
    max-width:900px;
    margin:auto;
    padding:16px;
}

h1{
    text-align:center;
    font-size:22px;
}

.card{
    background:white;
    border-radius:12px;
    padding:16px;
    margin-bottom:16px;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
}

label{
    font-size:14px;
    font-weight:bold;
}

input, button{
    width:100%;
    margin-top:6px;
    margin-bottom:12px;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
    font-size:16px;
}

button{
    background:#007aff;
    color:white;
    border:none;
    cursor:pointer;
}

button:disabled{
    background:#aaa;
}

.images{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
}

.image-box{
    flex:1;
    min-width:260px;
    text-align:center;
}

.image-box img{
    width:100%;
    border-radius:10px;
    background:#eee;
}

.status{
    text-align:center;
    font-size:14px;
    color:#555;
}

@media (max-width:600px){
    h1{
        font-size:18px;
    }
}
</style>
</head>

<body>

<div class="container">

<h1>脱毛後シミュレーター（テスト版）</h1>

<div class="card">

<label>OpenAI API Key</label>
<input id="apiKey" type="password" placeholder="sk-..." />

<label>モデル名</label>
<input id="model" value="gpt-image-1-mini" />

<label>画像（1人のみ写っている全身画像）</label>
<input id="imageInput" type="file" accept="image/*" />

<button id="generateBtn">脱毛後をシミュレーション</button>

<div class="status" id="status"></div>

</div>

<div class="card">
<div class="images">

<div class="image-box">
<p>元画像</p>
<img id="originalPreview"/>
</div>

<div class="image-box">
<p>生成結果</p>
<img id="resultImage"/>
</div>

</div>
</div>

</div>

<script>

const imageInput = document.getElementById("imageInput");
const originalPreview = document.getElementById("originalPreview");
const resultImage = document.getElementById("resultImage");
const btn = document.getElementById("generateBtn");
const statusText = document.getElementById("status");

let selectedFile = null;

// 画像プレビュー
imageInput.addEventListener("change", () => {
    selectedFile = imageInput.files[0];
    if(!selectedFile) return;

    const reader = new FileReader();
    reader.onload = e => {
        originalPreview.src = e.target.result;
    };
    reader.readAsDataURL(selectedFile);
});


// Base64変換
function fileToBase64(file){
    return new Promise((resolve)=>{
        const reader = new FileReader();
        reader.onload = () => {
            resolve(reader.result.split(",")[1]);
        };
        reader.readAsDataURL(file);
    });
}


btn.addEventListener("click", async ()=>{

    const apiKey = document.getElementById("apiKey").value.trim();
    const model = document.getElementById("model").value.trim();

    if(!apiKey || !selectedFile){
        alert("APIキーと画像を入力してください");
        return;
    }

    btn.disabled = true;
    statusText.textContent = "生成中...（20〜40秒程度かかる場合あり）";

    try{

        const base64Image = await fileToBase64(selectedFile);

        const prompt = `
この人物の全身の体毛を自然に除去してください。
肌を滑らかで自然な脱毛後の状態にしてください。
顔・体型・人物の特徴・ポーズ・服装・背景は維持してください。
美容広告のような自然な仕上がりにしてください。
`;

        const response = await fetch("https://api.openai.com/v1/images/edits",{
            method:"POST",
            headers:{
                "Authorization":"Bearer " + apiKey
            },
            body: (() => {
                const form = new FormData();
                form.append("model", model);
                form.append("prompt", prompt);
                form.append("image", selectedFile);
                return form;
            })()
        });

        const data = await response.json();

        if(!data.data){
            throw new Error(JSON.stringify(data));
        }

        const imageBase64 = data.data[0].b64_json;
        resultImage.src = "data:image/png;base64," + imageBase64;

        statusText.textContent = "生成完了";

    }catch(err){
        console.error(err);
        statusText.textContent = "エラー：" + err.message;
    }

    btn.disabled = false;

});

</script>

</body>
</html>