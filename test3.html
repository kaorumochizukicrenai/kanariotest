<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>メンズ着せ替えシミュレーター（テスト）</title>
  <style>
    :root { --bg:#f4f6f8; --card:#fff; --text:#222; --muted:#666; --blue:#007aff; }
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:980px; margin:0 auto; padding:16px; }
    h1{ text-align:center; font-size:22px; margin:10px 0 16px; }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    .card{ background:var(--card); border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.08); }
    label{ display:block; font-size:13px; font-weight:800; margin-top:10px; }
    input, select, button, textarea{
      width:100%; box-sizing:border-box; padding:10px; border-radius:10px;
      border:1px solid #cfcfcf; font-size:16px; margin-top:6px;
    }
    textarea{ min-height:72px; resize:vertical; }
    .row{ display:grid; grid-template-columns:1fr; gap:10px; }
    button{ background:var(--blue); color:#fff; border:none; cursor:pointer; font-weight:800; padding:12px; }
    button:disabled{ background:#9aa3ad; cursor:not-allowed; }
    .status{ font-size:13px; color:var(--muted); margin-top:10px; text-align:center; min-height:18px; }
    .note{ font-size:12px; color:var(--muted); line-height:1.5; margin-top:10px; }
    .images{ display:grid; grid-template-columns:1fr; gap:12px; }
    .imgbox{ text-align:center; }
    .imgbox p{ margin:6px 0 10px; font-weight:800; }
    .imgbox img{ width:100%; border-radius:12px; background:#eee; }
    .pill{ display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#eef3ff; color:#214ea3; border:1px solid #d7e3ff; }

    @media (min-width: 860px){
      .grid{ grid-template-columns: 380px 1fr; align-items:start; }
      .row{ grid-template-columns: 1fr 1fr; }
      .images{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>メンズ着せ替えシミュレーター（テスト版）</h1>

    <div class="grid">
      <div class="card">
        <div class="pill">背景・ポーズ・顔は維持して「服だけ」変更</div>

        <label>OpenAI API Key</label>
        <input id="apiKey" type="password" placeholder="sk-..." autocomplete="off" />

        <label>モデル名</label>
        <input id="model" value="gpt-image-1-mini" />

        <label>人物写真（1人のみ推奨）</label>
        <input id="imageInput" type="file" accept="image/*" capture="environment" />

        <label>着せ替えスタイル（メンズ）</label>
        <select id="outfitSelect"></select>

        <div class="row">
          <div>
            <label>雰囲気（任意）</label>
            <select id="vibe">
              <option value="clean">清潔感</option>
              <option value="street">ストリート</option>
              <option value="resort">リゾート</option>
              <option value="sporty">スポーティ</option>
              <option value="minimal">ミニマル</option>
            </select>
          </div>
          <div>
            <label>画質の指向（任意）</label>
            <select id="render">
              <option value="photo">写真っぽく自然</option>
              <option value="lookbook">ルックブック風</option>
            </select>
          </div>
        </div>

        <label>追加の要望（任意 / 例: “黒系で統一”, “サンダルは避けたい”）</label>
        <textarea id="extra" placeholder="任意。空でもOK"></textarea>

        <button id="generateBtn">この服装で生成</button>
        <div class="status" id="status"></div>

        <div class="note">
          ※テスト用途：厳密な試着（サイズの完全一致など）は保証外<br/>
          ※複数人・複雑な背景・顔隠れなどは精度が落ちます
        </div>
      </div>

      <div class="card">
        <div class="images">
          <div class="imgbox">
            <p>元画像</p>
            <img id="originalPreview" alt="original" />
          </div>
          <div class="imgbox">
            <p>着せ替え結果</p>
            <img id="resultImage" alt="result" />
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const outfitOptions = [
    // 肌見せ多め（半ズボン中心）
    { label: "タンクトップ + ナイロンショーツ + スポーツサンダル（夏）", prompt: "a men's outfit: tank top, nylon athletic shorts above the knee, sports sandals" },
    { label: "ノースリーブT + デニムショーツ + スニーカー", prompt: "a men's outfit: sleeveless t-shirt, denim shorts above the knee, sneakers" },
    { label: "白T（タイト） + チノショーツ + ローファー", prompt: "a men's outfit: fitted white t-shirt, chino shorts above the knee, loafers" },
    { label: "オープンカラー半袖シャツ（開け気味） + ショーツ + サンダル", prompt: "a men's outfit: open-collar short-sleeve shirt worn slightly open, shorts above the knee, sandals" },
    { label: "アロハシャツ + スイムショーツ + ビーチサンダル（リゾート）", prompt: "a men's outfit: aloha shirt, swim shorts, flip-flops" },
    { label: "メッシュタンク + ランニングショーツ + ランニングシューズ", prompt: "a men's outfit: mesh tank top, running shorts, running shoes" },
    { label: "ポロシャツ + ショートパンツ + デッキシューズ", prompt: "a men's outfit: polo shirt, short pants above the knee, deck shoes" },
    { label: "ボーダーT + リネンショーツ + エスパドリーユ", prompt: "a men's outfit: striped t-shirt, linen shorts, espadrilles" },
    { label: "フットボールシャツ + バスケショーツ + ハイカット", prompt: "a men's outfit: football jersey, basketball shorts, high-top sneakers" },
    { label: "半袖パーカー + ショーツ + ソックス&スニーカー（ストリート）", prompt: "a men's outfit: short-sleeve hoodie, shorts, crew socks and sneakers" },

    // さらに肌見せ（ショーツ + 上も軽め）
    { label: "タンクトップ（黒） + カーゴショーツ + ブーツ（ストリート）", prompt: "a men's outfit: black tank top, cargo shorts above the knee, boots" },
    { label: "ヘンリーネック半袖 + ショーツ + サンダル（大人カジュアル）", prompt: "a men's outfit: short-sleeve henley shirt, shorts, sandals" },
    { label: "シアー/薄手半袖シャツ + ショーツ + サンダル（涼しげ）", prompt: "a men's outfit: lightweight semi-sheer short-sleeve shirt, shorts, sandals" },
    { label: "タンクトップ + オーバーサイズ開襟シャツ羽織 + ショーツ", prompt: "a men's outfit: tank top with an oversized open-collar shirt worn open, shorts above the knee" },
    { label: "ランニング用シングレット + ショーツ + キャップ（スポーティ）", prompt: "a men's outfit: running singlet, athletic shorts, cap" },

    // 少しきれいめ（でもショーツ多め）
    { label: "リネンシャツ（腕まくり） + リネンショーツ + レザーサンダル", prompt: "a men's outfit: linen shirt with sleeves rolled up, linen shorts, leather sandals" },
    { label: "ニットポロ + ショーツ + ローファー（きれいめ）", prompt: "a men's outfit: knit polo shirt, tailored shorts above the knee, loafers" },
    { label: "ジャケット（薄手） + Tシャツ + ショーツ（セットアップ風）", prompt: "a men's outfit: lightweight blazer, t-shirt, tailored shorts (summer set-up style)" },

    // 参考：肌見せ少なめも少し混ぜる（比較用）
    { label: "Tシャツ + ワイドデニム（肌見せ少なめ）", prompt: "a men's outfit: t-shirt, wide-leg jeans" },
    { label: "シャツ + スラックス（きれいめ・肌見せ少なめ）", prompt: "a men's outfit: button-up shirt, slacks" }
  ];

  const imageInput = document.getElementById("imageInput");
  const originalPreview = document.getElementById("originalPreview");
  const resultImage = document.getElementById("resultImage");
  const outfitSelect = document.getElementById("outfitSelect");
  const btn = document.getElementById("generateBtn");
  const statusEl = document.getElementById("status");

  let selectedFile = null;

  // セレクトボックスに反映
  outfitOptions.forEach((o, idx) => {
    const opt = document.createElement("option");
    opt.value = String(idx);
    opt.textContent = o.label;
    outfitSelect.appendChild(opt);
  });

  imageInput.addEventListener("change", () => {
    selectedFile = imageInput.files?.[0] || null;
    if (!selectedFile) return;

    const r = new FileReader();
    r.onload = (e) => { originalPreview.src = e.target.result; };
    r.readAsDataURL(selectedFile);

    resultImage.removeAttribute("src");
    statusEl.textContent = "";
  });

  async function callImageEdit({ apiKey, model, file, prompt }) {
    const form = new FormData();
    form.append("model", model);
    form.append("prompt", prompt);
    form.append("image", file);

    const res = await fetch("https://api.openai.com/v1/images/edits", {
      method: "POST",
      headers: { "Authorization": "Bearer " + apiKey },
      body: form
    });

    const data = await res.json();

    if (!res.ok || !data?.data?.[0]?.b64_json) {
      throw new Error(data?.error?.message || JSON.stringify(data));
    }
    return "data:image/png;base64," + data.data[0].b64_json;
  }

  function buildPrompt({ outfit, vibe, render, extra }) {
    const vibeMap = {
      clean: "clean and neat, modern casual, well-groomed",
      street: "streetwear vibe, trendy, urban",
      resort: "resort vibe, relaxed, summery",
      sporty: "sporty athletic vibe, functional",
      minimal: "minimal and simple, monochrome-friendly"
    };

    const renderMap = {
      photo: "natural realistic photo, consistent lighting, no stylization",
      lookbook: "fashion lookbook photo, still realistic, consistent lighting"
    };

    // 「服以外は変えるな」を強く指示
    return `
You are an image editor. Edit ONLY the clothing on the person.
Keep the same person identity, face, hair, skin tone, body shape, pose, camera angle, framing, and background.
Do not change the location, background objects, lighting direction, shadows, or color tone.
Do not add text, logos, watermarks, or extra people.

Target: men's outfit change ONLY.
Replace the current outfit with:
- ${outfit}

Style direction:
- ${vibeMap[vibe] || vibeMap.clean}
- ${renderMap[render] || renderMap.photo}

Constraints:
- Keep hands, arms, legs, and face exactly as in the original pose.
- Preserve the original photo realism; avoid cartoon/anime/illustration.
- Keep the garment fit plausible and natural.

Additional request (optional):
- ${extra ? extra : "none"}
`;
  }

  btn.addEventListener("click", async () => {
    const apiKey = document.getElementById("apiKey").value.trim();
    const model = document.getElementById("model").value.trim();
    const vibe = document.getElementById("vibe").value;
    const render = document.getElementById("render").value;
    const extra = document.getElementById("extra").value.trim();

    if (!apiKey) { alert("APIキーを入力してください"); return; }
    if (!selectedFile) { alert("画像を選択してください"); return; }
    if (!model) { alert("モデル名を入力してください"); return; }

    const selected = outfitOptions[Number(outfitSelect.value)];
    const outfitPrompt = selected?.prompt || "a men's casual outfit";

    btn.disabled = true;
    statusEl.textContent = "生成中...（服装のみ変更します）";

    try {
      const prompt = buildPrompt({ outfit: outfitPrompt, vibe, render, extra });
      const url = await callImageEdit({ apiKey, model, file: selectedFile, prompt });
      resultImage.src = url;
      statusEl.textContent = "生成完了 ✅";
    } catch (e) {
      console.error(e);
      statusEl.textContent = "エラー: " + (e?.message || String(e));
      alert("生成に失敗しました。\n" + (e?.message || String(e)));
    } finally {
      btn.disabled = false;
    }
  });
</script>
</body>
</html>